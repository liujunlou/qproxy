name: Build QProxy Docker

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  release:
    types: [ published ]

jobs:
  build-docker:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get version
      id: version
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | cut -d'"' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION"

    - name: Build multi-arch Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: false
        load: false
        outputs: type=docker,dest=/tmp/qproxy.tar

    - name: Create deployment package
      run: |
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        PACKAGE_NAME="qproxy-docker-${{ steps.version.outputs.version }}"
        mkdir -p $PACKAGE_NAME
        
        # å¤åˆ¶Dockeré•œåƒ
        cp /tmp/qproxy.tar $PACKAGE_NAME/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp config.json $PACKAGE_NAME/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > $PACKAGE_NAME/deploy.sh << 'EOF'
#!/bin/bash

set -e

echo "å¼€å§‹éƒ¨ç½² QProxy..."

# åŠ è½½é•œåƒ
echo "ðŸ“¦ åŠ è½½ Docker é•œåƒ..."
docker load -i qproxy.tar

# åˆ›å»ºç½‘ç»œ
echo "ðŸŒ åˆ›å»º Docker ç½‘ç»œ..."
docker network create qproxy-network 2>/dev/null || true

# å¯åŠ¨å®¹å™¨
echo "â–¶ï¸  å¯åŠ¨ QProxy å®¹å™¨..."
docker run -d \
  --name qproxy \
  --network qproxy-network \
  -p 8080:8080 \
  -p 8082:8082 \
  -p 8084:8084 \
  -p 8085:8085 \
  -v $(pwd)/config.json:/app/config.json:ro \
  -v qproxy_logs:/app/logs \
  --restart unless-stopped \
  qproxy:latest

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ðŸ“Š å®¹å™¨çŠ¶æ€: docker ps"
echo "ðŸ“‹ æŸ¥çœ‹æ—¥å¿—: docker logs -f qproxy"
EOF

        # åˆ›å»ºåœæ­¢è„šæœ¬
        cat > $PACKAGE_NAME/stop.sh << 'EOF'
#!/bin/bash

echo "ðŸ›‘ åœæ­¢ QProxy æœåŠ¡..."
docker stop qproxy 2>/dev/null || true
docker rm qproxy 2>/dev/null || true

echo "âœ… æœåŠ¡å·²åœæ­¢"
EOF

        # åˆ›å»ºREADME
        cat > $PACKAGE_NAME/README.md << EOF
# QProxy Docker éƒ¨ç½²åŒ…

ç‰ˆæœ¬: ${{ steps.version.outputs.version }}

## ç³»ç»Ÿè¦æ±‚

- Docker 20.10+
- æ”¯æŒ ARM64 æˆ– x86_64 æž¶æž„

## å¿«é€Ÿå¼€å§‹

1. è§£åŽ‹åŒ…æ–‡ä»¶
2. è¿è¡Œéƒ¨ç½²è„šæœ¬:
   \`\`\`bash
   chmod +x deploy.sh
   ./deploy.sh
   \`\`\`

3. åœæ­¢æœåŠ¡:
   \`\`\`bash
   chmod +x stop.sh
   ./stop.sh
   \`\`\`

## ç«¯å£è¯´æ˜Ž

- 8080: HTTPä»£ç†
- 8082: TCPä»£ç†  
- 8084: å¯¹ç­‰èŠ‚ç‚¹
- 8085: TCPåè®®

## é…ç½®

ç¼–è¾‘ \`config.json\` æ–‡ä»¶æ¥ä¿®æ”¹é…ç½®ã€‚

## æ—¥å¿—

æŸ¥çœ‹æ—¥å¿—:
\`\`\`bash
docker logs -f qproxy
\`\`\`

## æ•°æ®æŒä¹…åŒ–

æ—¥å¿—æ•°æ®å­˜å‚¨åœ¨ Docker å· \`qproxy_logs\` ä¸­ã€‚
EOF

        chmod +x $PACKAGE_NAME/deploy.sh
        chmod +x $PACKAGE_NAME/stop.sh

    - name: Create compressed packages
      run: |
        PACKAGE_NAME="qproxy-docker-${{ steps.version.outputs.version }}"
        
        # åˆ›å»º tar.gz åŒ…
        tar -czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"
        
        # åˆ›å»º zip åŒ…
        zip -r "${PACKAGE_NAME}.zip" "$PACKAGE_NAME"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qproxy-docker-package
        path: |
          qproxy-docker-*.tar.gz
          qproxy-docker-*.zip
        retention-days: 30

  # å‘å¸ƒåˆ° GitHub Releases
  release:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: qproxy-docker-package
        
    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./qproxy-docker-*.tar.gz
        asset_name: qproxy-docker-${{ steps.version.outputs.version }}.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload release assets (zip)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./qproxy-docker-*.zip
        asset_name: qproxy-docker-${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip 